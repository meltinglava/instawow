---
name: Create stand-alone executable
on:
  push:
jobs:
  freeze:
    strategy:
      matrix:
        os: [macos-latest, ubuntu-latest]
    runs-on: ${{ matrix.os }}
    steps:
    - name: Clone the repo
      uses: actions/checkout@v2
    - if: matrix.os != 'ubuntu-latest'
      name: Install Rust toolchain
      uses: actions-rs/toolchain@v1
      with:
        profile: minimal
        toolchain: nightly
    - if: matrix.os == 'ubuntu-latest'
      name: Install Rust toolchain incl. universal Linux target
      uses: actions-rs/toolchain@v1
      with:
        profile: minimal
        toolchain: nightly
        target: x86_64-unknown-linux-musl
    - name: Install PyOxidizer
      run: |
        cargo install --version 0.7.0 pyoxidizer
    - if: matrix.os != 'ubuntu-latest'
      name: Build binary
      run: |
        mkdir -p dist
        pyoxidizer build --release | tee >(cp $(tail -n 1 | cut -c 23-) dist/instawow)
    - if: matrix.os == 'ubuntu-latest'
      name: Build binary for Linux
      run: |
        mkdir -p dist
        pyoxidizer build --target x86_64-unknown-linux-musl --release | \
          tee >(cp $(tail -n 1 | cut -c 23-) dist/instawow)
    - name: Confirm the binary is working
      run: |
        dist/instawow --version
    - name: Upload binary
      uses: actions/upload-artifact@v1
      with:
        name: instawow-${{ matrix.os }}
        path: dist/instawow
